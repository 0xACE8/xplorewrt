#
# Copyright (c) 2019-2026 0xACE8
#
# æœ¬ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã¯ãƒ•ãƒªãƒ¼ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã§ã‚ã‚Šã€MITãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã®ä¸‹ã§å…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚
# è©³ç´°ã«ã¤ã„ã¦ã¯ /LICENSE ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
#
# https://github.com/0xACE8
#
# èª¬æ˜: GitHub Actionsã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ã‚’æ´»ç”¨ã—ã€ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ç¢ºä¿ã—ãŸOpenWrtãƒ“ãƒ«ãƒ‰ã€‚
#

name: Build cudy_tr3000-v1 128mb ponly 24.10 kernel 6.6 actions.

on:
  workflow_dispatch:
    inputs:
      restore_config:
        description: 'Restore Configuration ğŸ‡¯ğŸ‡µ è¨­å®šã‚’å¾©å…ƒ'
        type: boolean
        default: false
      telegram_notify:
        description: 'Telegram Notification ğŸ‡¯ğŸ‡µ Telegramé€šçŸ¥'
        type: boolean
        default: false
      upload_firmware:
        description: 'Upload to Artifactsã€€ ğŸ‡¯ğŸ‡µ Artifactã«ä¿å­˜'
        type: boolean
        default: false
      upload_release:
        description: 'Upload to Releaseã€€ã€€ ğŸ‡¯ğŸ‡µ Releaseã«å…¬é–‹'
        type: boolean
        default: false
      upload_wenshushu:
        description: 'Upload to WENSHUSHUã€€ ğŸ‡¯ğŸ‡µ æ–‡å”å”ã«è»¢é€'
        type: boolean
        default: false
#  schedule:
#    - cron: '0 19 * * 0'

env:
  # annawrt 2410
  PONLY2410_K66_REPO_LINK:                  ${{ secrets.PONLY2410_K66_REPO_LINK }}
  PONLY2410_K66_REPO_TREE:                  ${{ secrets.PONLY2410_K66_REPO_TREE }}
  PONLY2410_K66_REPO_HEAD:                  ${{ secrets.PONLY2410_K66_REPO_HEAD }}
  PONLY2410_K66_REPO_DIFF:                  ${{ secrets.PONLY2410_K66_REPO_DIFF }}
  # cmcc-xr30-emmc
  CUDY_TR3000_128MB_PONLY2410_K66_PATCHES:  ${{ secrets.CUDY_TR3000_128MB_PONLY2410_K66_PATCHES }}
  CUDY_TR3000_128MB_PONLY2410_K66_PROFILE:  ${{ secrets.CUDY_TR3000_128MB_PONLY2410_K66_PROFILE }}
  CUDY_TR3000_COMON_PONLY2410_K66_ARCHIVE:  ${{ secrets.CUDY_TR3000_COMON_PONLY2410_K66_ARCHIVE }}
  # token
  GH_TOKEN:                                 ${{ secrets.ACCESS_TOKEN }}
  ACCESS_TOKEN:                             ${{ secrets.ACCESS_TOKEN }}
  # feeds source
  ADD_EXTRA_SOURCE:                         ${{ secrets.ADD_EXTRA_SOURCE }}
  # check sha512sum
  ACCESS_SHA512SUM:                         ${{ secrets.ACCESS_SHA512SUM }}
  ACCESS_REPACKAGE:                         ${{ secrets.ACCESS_REPACKAGE }}
  # luci & packages repo
  PLUGIN_REPO_SLUG:                         ${{ secrets.PLUGIN_REPO_SLUG }}
  PLUGIN_REPO_HEAD:                         ${{ secrets.PLUGIN_REPO_HEAD }}
  PLUGIN_REPO_FLOW:                         ${{ secrets.PLUGIN_REPO_FLOW }}
  # cmcc color sytle for argon
  ARGON_THEME_CUDY:                         ${{ secrets.ARGON_THEME_CUDY }}
  # telegram bot
  TELEGRAM_BOT_KEY:                         ${{ secrets.TELEGRAM_BOT_KEY }}
  TELEGRAM_CHAT_ID:                         ${{ secrets.TELEGRAM_CHAT_ID }}
  # hardware & repo info
  DEVICE_NAME:                              CUDY_TR3000-v1
  TARGET_CHIP:                              mt7981b
  TARGET_DISK:                              SPI_NAND_128MB
  SOURCE_CODE:                              padavanonly
  KERNEL_VERS:                              KERNEL_6.6.95
  OUTPUT_FILE:                              xplorewrt-24.10-k6.6-mt7981b-cudy_tr3000-v1-128mb-sysupgrade
  TZ: "Asia/Tokyo"

jobs:
  build:
    runs-on: ubuntu-22.04

    permissions:
      contents: write

    steps:
    - name: Sync and Wait for Plugin Repo (ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒªãƒã‚¸ãƒˆãƒªã®åŒæœŸã¨å¾…æ©Ÿ)
      run: |
        echo "ğŸ” Checking last successful sync time..."
        
        LAST_RUN_TIME=$(gh run list --workflow "$PLUGIN_REPO_FLOW" --repo "$PLUGIN_REPO_SLUG" --status success --limit 1 --json updatedAt --jq '.[0].updatedAt')
        DO_SYNC="true"
        
        if [ -n "$LAST_RUN_TIME" ] && [ "$LAST_RUN_TIME" != "null" ]; then
          LAST_TS=$(date -d "$LAST_RUN_TIME" +%s)
          NOW_TS=$(date +%s)
          DIFF=$((NOW_TS - LAST_TS))
          
          if [ "$DIFF" -lt 86400 ]; then
            echo "â­ï¸ Last sync was only $((DIFF / 3600)) hours ago (Success at: $LAST_RUN_TIME). Skipping."
            DO_SYNC="false"
          else
            echo "âš ï¸ Last sync was $((DIFF / 3600)) hours ago. Update needed."
          fi
        else
          echo "âš ï¸ No previous successful run found. Forcing sync."
        fi

        if [ "$DO_SYNC" == "true" ]; then
          echo "ğŸš€ Triggering workflow..."

          if ! gh workflow run "$PLUGIN_REPO_FLOW" --repo "$PLUGIN_REPO_SLUG" --ref "$PLUGIN_REPO_HEAD"; then
            echo "âŒ Error: Failed to trigger the workflow."
            exit 1
          fi
            
          echo "ğŸ•µï¸â€â™‚ï¸ Waiting for Run ID..."
          echo "â³ Max wait time: 10 minutes (60 attempts x 10s)"
            
          FOUND_ID=""
          
          for i in {1..60}; do
            echo "   Attempt $i/60: Checking for active runs..."
            sleep 10
            
            RUN_ID=$(gh run list --workflow "$PLUGIN_REPO_FLOW" --repo "$PLUGIN_REPO_SLUG" --limit 1 --json databaseId,status --jq 'map(select(.status != "completed")) | .[0].databaseId')
              
            if [ -n "$RUN_ID" ] && [ "$RUN_ID" != "null" ]; then
              FOUND_ID=$RUN_ID
              echo "âœ… Caught the Run ID! Run ID: $FOUND_ID"
              break
            fi
          done
            
          if [ -z "$FOUND_ID" ]; then
            echo "âŒ Error: Timed out after 10 minutes waiting for Run ID"
            echo "   Possible reason: GitHub Actions queue is extremely busy."
            exit 1
          fi
            
          echo "ğŸ‘€ Waiting sync..."

          gh run watch "$FOUND_ID" --repo "$PLUGIN_REPO_SLUG" --exit-status
          echo "ğŸ½ï¸ Plugin sync complete"
        else
          echo "ğŸ˜´ Skipping sync to save resources (Recently synced)."
        fi

    - name: Checkout (ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ)
      uses: actions/checkout@main
      with:
        fetch-depth: 0

    - name: Pre-Free Disk Space (ãƒ‡ã‚£ã‚¹ã‚¯è§£æ”¾å‰ã®æº–å‚™)
      run: |
        echo "ãƒ‡ã‚£ã‚¹ã‚¯è§£æ”¾å‰ã®æº–å‚™"
        echo "=============================================================================="
        df -hT
        echo "=============================================================================="

    - name: Optimize Disk Space (ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ã®æœ€é©åŒ–)
      uses: hugoalh/disk-space-optimizer-ghaction@v0.8.1
      with:
        operate_sudo: "True"
        general_include: ".+"
        general_exclude: |-
          ^GCC$
          ^G\+\+$
          Clang
          LLVM
        docker_include: ".+"
        docker_prune: "True"
        docker_clean: "True"
        apt_prune: "True"
        apt_clean: "True"
        homebrew_prune: "True"
        homebrew_clean: "True"
        npm_prune: "True"
        npm_clean: "True"
        os_swap: "True"

    - name: Free Disk Space (ãƒ‡ã‚£ã‚¹ã‚¯ç©ºãå®¹é‡ã®ç¢ºä¿)
      uses: easimon/maximize-build-space@master
      with: 
        root-reserve-mb: 8192
        swap-size-mb: 1
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'

    - name: Check Server Performance (ã‚µãƒ¼ãƒãƒ¼æ€§èƒ½ã®ç¢ºèª)
      run: |
        echo "âš ï¸æ³¨æ„âš ï¸"
        echo "ã‚µãƒ¼ãƒãƒ¼ã®ãƒªã‚½ãƒ¼ã‚¹ã¯æœ‰é™ã§ã™ã€‚ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®éå‰°ãªé¸æŠã¯CPUé«˜è² è·ã®åŸå› ã¨ãªã‚Šã¾ã™ã€‚"
        echo -e "æ—¢çŸ¥ã®CPUãƒ¢ãƒ‡ãƒ«ï¼ˆé™é †ï¼‰: 7763ï¼Œ8370Cï¼Œ8272CLï¼Œ8171Mï¼ŒE5-2673\n"
        echo "-------------------------CPU æƒ…å ±---------------------------"
        echo "CPUã®ç‰©ç†æ•°  : $(cat /proc/cpuinfo | grep "physical id" | sort | uniq | wc -l)"
        echo "CPUã‚³ã‚¢æ•°    : $(nproc)"
        echo -e "CPUãƒ¢ãƒ‡ãƒ«æƒ…å ±:$(cat /proc/cpuinfo | grep -m1 name | awk -F: '{print $2}')\n"
        echo "------------------------ãƒ¡ãƒ¢ãƒªæƒ…å ±--------------------------"
        echo "ãƒ¡ãƒ¢ãƒªã®è©³ç´°:"
        echo -e "$(sudo lshw -short -C memory | grep GiB)\n"
        echo "---------------------ãƒãƒ¼ãƒ‰ãƒ‡ã‚£ã‚¹ã‚¯æƒ…å ±---------------------"
        echo "ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡: $(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT

    - name: Initialize Environment (ç’°å¢ƒã®åˆæœŸåŒ–)
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt -yqq update
        sudo -E apt -yqq full-upgrade
        sudo -E apt -yqq autoremove --purge
        sudo -E apt -yqq autoclean
        sudo -E apt -yqq clean
        sudo -E apt -yqq install zip rename dos2unix libfuse-dev
        sudo bash -c 'bash <(curl -sL https://build-scripts.immortalwrt.org/init_build_environment.sh)'
        sudo -E apt -yqq install cargo
        rustup target add aarch64-unknown-linux-musl
        sudo -E systemctl daemon-reload
        sudo timedatectl set-timezone "$TZ"
        sudo chown $USER:$GROUPS $GITHUB_WORKSPACE

    - name: Setup Git Credentials (Gitèªè¨¼æƒ…å ±ã®è¨­å®š)
      run: |
        git config --global url."https://$ACCESS_TOKEN@github.com/0xACE8/".insteadOf "https://github.com/0xACE8/"
        
    - name: Clone Source Code (ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ã‚¯ãƒ­ãƒ¼ãƒ³)
      working-directory: ./
      run: |
        df -hT $PWD
        git clone $PONLY2410_K66_REPO_LINK -b $PONLY2410_K66_REPO_HEAD openwrt
        echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV

        # Remove China Mirrors (ä¸­å›½å›½å†…ãƒŸãƒ©ãƒ¼ã®å‰Šé™¤)
        PROJECT_MIRRORS_FILE="scripts/projectsmirrors.json"
          if [ -f "$PROJECT_MIRRORS_FILE" ]; then
            sed -i '/.cn\//d; /tencent/d; /aliyun/d' "$PROJECT_MIRRORS_FILE"
          fi

    - name: Cache Toolchain (ãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥)
      uses: HiGarfield/cachewrtbuild@main
      with:
        ccache: true
        mixkey: MT7981b-[${{ env.SOURCE_CODE }}]-[${{ secrets.PONLY2410_K66_REPO_TREE }}]-[${{ secrets.PONLY2410_K66_REPO_HEAD }}]-[${{ env.KERNEL_VERS }}]
        prefix: ${{ env.OPENWRT_PATH }}

    - name: Update & Install Feeds (ãƒ•ã‚£ãƒ¼ãƒ‰ã®æ›´æ–°ã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«)
      working-directory: ./openwrt
      run: |
        ${{ secrets.CUDY_TR3000_128MB_PONLY2410_K66_PATCHES }}
        ${{ secrets.ADD_EXTRA_SOURCE }}
        ./scripts/feeds update -a
        rm -rf feeds/packages/lang/golang
        git clone https://github.com/sbwml/packages_lang_golang -b 25.x feeds/packages/lang/golang
        ./scripts/feeds install -a
        ./scripts/feeds install -a

    - name: Load Custom Configuration (ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã®èª­ã¿è¾¼ã¿)
      working-directory: ./openwrt
      id: loadconfig
      run: |
        ${{ secrets.CUDY_TR3000_128MB_PONLY2410_K66_PROFILE }}
        ${{ secrets.PONLY2410_K66_REPO_DIFF }}
        ${{ secrets.ARGON_THEME_CUDY }}

    - name: Restore Config Archive (è¨­å®šã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®å¾©å…ƒ)
      if: steps.loadconfig.outcome == 'success' && (github.event.inputs.restore_config == 'true' || contains(github.event.action, 'restore_config')) && !cancelled()
      working-directory: ./openwrt
      run: |
        rm -rf files
        ${{ secrets.CUDY_TR3000_COMON_PONLY2410_K66_ARCHIVE }}

    - name: Boost Wi-Fi 5G Signal (Wi-Fi 5Gä¿¡å·ã®å¢—å¹…)
      if: steps.loadconfig.outcome == 'success' && !cancelled()
      working-directory: ./openwrt
      run: |
        ${{ secrets.BOOST_5G_TO_25DBM }}

    - name: Download Packages (ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰)
      if: steps.loadconfig.outcome == 'success' && !cancelled()
      working-directory: ./openwrt
      id: package
      run: |
        make defconfig
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: Compile Firmware (ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«)
      working-directory: ./openwrt
      id: compile
      run: |
        echo -e "$(nproc) thread compile"
        make -j$(($(nproc) + 1)) || make -j1 V=s
        echo "FILE_DATE=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: Update Variables (å¤‰æ•°ã®æ›´æ–°)
      run: |
        echo "OUTPUT_FILE=${OUTPUT_FILE}_${FILE_DATE}" >> $GITHUB_ENV

    - name: Check Disk Usage (ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡ã®ç¢ºèª)
      if: (!cancelled())
      run: df -hT

    - name: Notify Compilation Error (ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã®é€šçŸ¥)
      if: steps.compile.outcome != 'success' && (github.event.inputs.telegram_notify == 'true' || contains(github.event.action, 'telegram_notify')) && !cancelled()
      env:
        INPUT_RESTORE: ${{ github.event.inputs.restore_config }}
        INPUT_ARTIFACT: ${{ github.event.inputs.upload_firmware }}
        INPUT_RELEASE: ${{ github.event.inputs.upload_release }}
        INPUT_WENSHUSHU: ${{ github.event.inputs.upload_wenshushu }}
        SOURCE_TREE: ${{ secrets.PONLY2410_K66_REPO_TREE }}
        SOURCE_HEAD: ${{ secrets.PONLY2410_K66_REPO_HEAD }}
      run: |
        MSG="âŒ ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸï¼ âŒ"
        MSG="${MSG}%0A%0Aï¼ï¼ï¼ï¼ï¼  åŸº æœ¬ æƒ… å ±  ï¼ï¼ï¼ï¼ï¼"
        MSG="${MSG}%0AğŸ–¥ï¸å¯¾å¿œæ©Ÿç¨®: ${DEVICE_NAME}"
        MSG="${MSG}%0AğŸ’¿å®¹é‡ä»•æ§˜: ${TARGET_DISK}"
        MSG="${MSG}%0AğŸ§ã‚«ãƒ¼ãƒãƒ«: ${KERNEL_VERS}"
        MSG="${MSG}%0AğŸ‘¤ã‚½ãƒ¼ã‚¹å: ${SOURCE_CODE}"
        MSG="${MSG}%0AğŸŒ²ã‚½ãƒ¼ã‚¹å…ƒ: ${SOURCE_TREE}"
        MSG="${MSG}%0AğŸŒ¿ãƒ–ãƒ©ãƒ³ãƒ: ${SOURCE_HEAD}"

        MSG="${MSG}%0A%0Aï¼ï¼ï¼ï¼ï¼  çŠ¶ æ…‹ ä¸€ è¦§  ï¼ï¼ï¼ï¼ï¼"
        MSG="${MSG}%0Aâš™ï¸è¨­å®šå¾©å…ƒ: ${STAT_RESTORE}"
        MSG="${MSG}%0AğŸ’¾æ§‹ç¯‰æˆæœ: ${STAT_ARTIFACT}"
        MSG="${MSG}%0AğŸš€å…¬é–‹é…ä¿¡: ${STAT_RELEASE}"
        MSG="${MSG}%0Aâ˜ï¸æ–‡æ°è»¢é€: ${STAT_WEN}"
        
        MSG="${MSG}%0A%0Aï¼ï¼ï¼ï¼  ã‚¨ ãƒ© ãƒ¼ æƒ… å ±   ï¼ï¼ï¼ï¼"
        MSG="${MSG}%0AâŒå¤±æ•—æ™‚åˆ»: $(date +'%Yå¹´%mæœˆ%dæ—¥_%Hæ™‚%Måˆ†')"
        MSG="${MSG}%0Aï¼ï¼ï¼-----------------------ï¼ï¼ï¼"

        FINAL_MSG=$(echo "$MSG" | sed 's/ /%20/g')

        curl -s -o /dev/null -X GET "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_KEY }}/sendMessage" \
          -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d text="${FINAL_MSG}"

    - name: Organize Files (ãƒ•ã‚¡ã‚¤ãƒ«ã®æ•´ç†)
      id: organize
      if: steps.compile.outcome == 'success' && !cancelled()
      run: |
        cd openwrt/bin/targets/*/*
        ls | grep -v *sysupgrade.bin | xargs rm -rdf
        mv *.bin ${{ env.OUTPUT_FILE }}.bin
        sha512sums ${{ secrets.ACCESS_SHA512SUM }} sha512sums ${{ env.OUTPUT_FILE }}.bin
        ${{ secrets.ACCESS_REPACKAGE }} ${{ env.OUTPUT_FILE }}.bin
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV

    - name: Upload to Artifacts (Artifactã«ä¿å­˜)
      if: steps.organize.outcome == 'success' && (github.event.inputs.upload_firmware == 'true' || contains(github.event.action, 'upload_firmware')) && !cancelled()
      uses: actions/upload-artifact@main
      with:
        name: ${{ env.OUTPUT_FILE }}
        path: ${{ env.FIRMWARE }}

    - name: Upload to Release (Releaseã«å…¬é–‹)
      if: steps.organize.outcome == 'success' && (github.event.inputs.upload_release == 'true' || contains(github.event.action, 'upload_release')) && !cancelled()
      uses: actions/github-script@v7
      env:
        REPO_TREE: ${{ secrets.PONLY2410_K66_REPO_TREE }}
        REPO_HEAD: ${{ secrets.PONLY2410_K66_REPO_HEAD }}
        GITHUB_TOKEN: ${{ env.GH_TOKEN }}
      with:
        github-token: ${{ env.GH_TOKEN }}
        script: |
          const fs = require('fs');
          const path = require('path');
          const { owner, repo } = context.repo;

          const env = process.env; 
          
          console.log(`â„¹ï¸ Target: ${env.DEVICE_NAME}, Date: ${env.FILE_DATE}`);

          const tagName = `${env.FILE_DATE}`;
          const releaseName = `${env.TARGET_CHIP}_${env.DEVICE_NAME}_${env.TARGET_DISK}_${env.KERNEL_VERS}_${env.FILE_DATE}`;

          const body = `
          **æœ¬ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã¯ã€CPUã€Œ${env.TARGET_CHIP}ã€æ­è¼‰ã®ãƒ¢ãƒ‡ãƒ«ã€Œ${env.DEVICE_NAME}ã€âœ… ${env.TARGET_DISK} âœ…å°‚ç”¨ã§ã™ã€‚**
          ### ğŸ“’ã€Œ${env.SOURCE_CODE}ã€ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’åŸºã«ãƒ“ãƒ«ãƒ‰ã•ã‚Œã¾ã—ãŸã€‚
          - ğŸ–¥ï¸ å¯¾å¿œæ©Ÿç¨®: ${env.DEVICE_NAME}
          - ğŸ’¿ å®¹é‡ä»•æ§˜: ${env.TARGET_DISK}
          - ğŸ§ ã‚«ãƒ¼ãƒãƒ«: ${env.KERNEL_VERS}
          - ğŸ‘¤ ã‚½ãƒ¼ã‚¹å: ${env.SOURCE_CODE}
          - ğŸŒ² ã‚½ãƒ¼ã‚¹å…ƒ: ${env.REPO_TREE}
          - ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒ: ${env.REPO_HEAD}
          - ğŸ”— ç®¡ç†ï¼©ï¼°: 192.168.***.1 ã¾ãŸã¯ ${env.SOURCE_CODE}.lan
          - ğŸ›¡ï¸ åˆæœŸãƒ‘ã‚¹: ********
          ### âš ï¸ å…è²¬äº‹é … âš ï¸
          - â€¼ï¸ **æœ¬ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã¯ã€å€‹äººåˆ©ç”¨ã‚’ç›®çš„ã¨ã—ãŸéå…¬å¼ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºç‰ˆã§ã™ã€‚**
          - â›”ï¸ **å¼·åˆ¶ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ç­‰ã§ãƒ‡ãƒã‚¤ã‚¹ãŒç ´æã—ãŸå ´åˆã€æœ¬ãƒªãƒã‚¸ãƒˆãƒªã¯ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚è‡ªå·±è²¬ä»»ã§ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚**
          `;

          let release_id;
          try {
            console.log(`ğŸ†• Creating Release: ${tagName}`);
            const { data: newRelease } = await github.rest.repos.createRelease({
              owner, repo,
              tag_name: tagName,
              target_commitish: context.sha,
              name: releaseName,
              body: body.trim(),
              draft: false,
              prerelease: false,
              generate_release_notes: false
            });
            release_id = newRelease.id;
          } catch (e) {
             console.log(`âš ï¸ Create failed: ${e.message}`);
             throw e;
          }

          const firmDir = env.FIRMWARE;
          if (fs.existsSync(firmDir)) {
            const files = fs.readdirSync(firmDir);
            for (const file of files) {
              const filePath = path.join(firmDir, file);
              if (fs.lstatSync(filePath).isFile()) {
                console.log(`â¬†ï¸ Uploading: ${file}`);
                try {
                  await github.rest.repos.uploadReleaseAsset({
                    owner, repo,
                    release_id: release_id,
                    name: file,
                    data: fs.readFileSync(filePath)
                  });
                } catch (e) { console.error(`âŒ Upload failed: ${e.message}`); }
              }
            }
          }

    - name: Upload to wenshushu (ã‚¦ã‚§ãƒ³ãŠã˜ã•ã‚“ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹)
      if: steps.compile.outcome == 'success' && steps.organize.outcome == 'success' && (github.event.inputs.upload_wenshushu == 'true' || contains(github.event.action, 'upload_wenshushu')) && !cancelled()
      working-directory: ./openwrt
      run: |
        curl -fsSL git.io/file-transfer | sh
        ./transfer wss -s -p 16 -t 600 --no-progress ${FIRMWARE} 2>&1 | tee wenshushu.log
        WENSHUSHU=$(cat wenshushu.log | grep 'Manage Link:' | cut -d' ' -f3-)
        echo "WENSHUSHU=$WENSHUSHU" >> $GITHUB_ENV

    - name: ğŸ“¢ Final Report & TG Notify (ç·åˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é€šçŸ¥)
      if: steps.organize.outcome == 'success' && (github.event.inputs.telegram_notify == 'true' || contains(github.event.action, 'telegram_notify')) && !cancelled()
      env:
        INPUT_RESTORE: ${{ github.event.inputs.restore_config }}
        INPUT_ARTIFACT: ${{ github.event.inputs.upload_firmware }}
        INPUT_RELEASE: ${{ github.event.inputs.upload_release }}
        INPUT_WENSHUSHU: ${{ github.event.inputs.upload_wenshushu }}
        SOURCE_TREE: ${{ secrets.PONLY2410_K66_REPO_TREE }}
        SOURCE_HEAD: ${{ secrets.PONLY2410_K66_REPO_HEAD }}
        WENSHUSHU_URL: ${{ env.WENSHUSHU }}
      run: |
        if [[ "$INPUT_RESTORE" == "true" ]] || [[ "$GITHUB_EVENT_ACTION" == *"restore_config"* ]]; then
            STAT_RESTORE="âœ…"
        else
            STAT_RESTORE="âºï¸"
        fi
        if [[ "$INPUT_ARTIFACT" == "true" ]] || [[ "$GITHUB_EVENT_ACTION" == *"upload_firmware"* ]]; then
            STAT_ARTIFACT="âœ…"
        else
            STAT_ARTIFACT="âºï¸"
        fi
        if [[ "$INPUT_RELEASE" == "true" ]] || [[ "$GITHUB_EVENT_ACTION" == *"upload_release"* ]]; then
            STAT_RELEASE="âœ…"
        else
            STAT_RELEASE="âºï¸"
        fi
        if [[ -n "$WENSHUSHU_URL" ]]; then
            STAT_WEN="âœ…"
            WEN_MSG="ãƒ»ğŸ§™ğŸ¼â€â™‚ï¸æ–‡æ°è»¢é€:%0Aã€€ã€€$WENSHUSHU_URL"
        elif [[ "$INPUT_WENSHUSHU" == "true" ]] || [[ "$GITHUB_EVENT_ACTION" == *"upload_wenshushu"* ]]; then
            STAT_WEN="âŒ (å¤±æ•—)" 
            WEN_MSG=""
        else
            STAT_WEN="âºï¸"
            WEN_MSG=""
        fi

        MSG="âœ… ãƒ“ãƒ«ãƒ‰ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼ âœ…"
        MSG="${MSG}%0A%0Aï¼ï¼ï¼ï¼ï¼  åŸº æœ¬ æƒ… å ±  ï¼ï¼ï¼ï¼ï¼"
        MSG="${MSG}%0AğŸ–¥ï¸å¯¾å¿œæ©Ÿç¨®: ${DEVICE_NAME}"
        MSG="${MSG}%0AğŸ’¿å®¹é‡ä»•æ§˜: ${TARGET_DISK}"
        MSG="${MSG}%0AğŸ§ã‚«ãƒ¼ãƒãƒ«: ${KERNEL_VERS}"
        MSG="${MSG}%0AğŸ‘¤ã‚½ãƒ¼ã‚¹å: ${SOURCE_CODE}"
        MSG="${MSG}%0AğŸŒ²ã‚½ãƒ¼ã‚¹å…ƒ: ${SOURCE_TREE}"
        MSG="${MSG}%0AğŸŒ¿ãƒ–ãƒ©ãƒ³ãƒ: ${SOURCE_HEAD}"

        MSG="${MSG}%0A%0Aï¼ï¼ï¼ï¼ï¼  çŠ¶ æ…‹ ä¸€ è¦§  ï¼ï¼ï¼ï¼ï¼"
        MSG="${MSG}%0Aâš™ï¸è¨­å®šå¾©å…ƒ: ${STAT_RESTORE}"
        MSG="${MSG}%0AğŸ’¾æ§‹ç¯‰æˆæœ: ${STAT_ARTIFACT}"
        MSG="${MSG}%0AğŸš€å…¬é–‹é…ä¿¡: ${STAT_RELEASE}"
        MSG="${MSG}%0Aâ˜ï¸æ–‡æ°è»¢é€: ${STAT_WEN}"
        
        MSG="${MSG}%0A%0Aï¼ï¼ï¼ï¼ï¼  ä¸‹ è¼‰ ä¿¡ æ¯  ï¼ï¼ï¼ï¼ï¼"
        MSG="${MSG}%0AğŸ“¦ãƒ•ã‚¡ã‚¤ãƒ«:%0Aã€€ã€€${FILENAME}"

        if [[ -n "$WEN_MSG" ]]; then
             MSG="${MSG}%0A${WEN_MSG}"
        fi
        
        MSG="${MSG}%0Aï¼ï¼ï¼-----------------------ï¼ï¼ï¼"

        FINAL_MSG=$(echo "$MSG" | sed 's/ /%20/g')

        curl -s -o /dev/null -X GET "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_KEY }}/sendMessage" \
          -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d text="${FINAL_MSG}"

    - name: Delete Old Workflows (å¤ã„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å‰Šé™¤)
      uses: actions/github-script@v7
      with:
        github-token: ${{ env.GH_TOKEN }}
        script: |
          const { owner, repo } = context.repo;
          const currentRunId = context.runId;
          
          const runs = await github.rest.actions.listWorkflowRunsForRepo({
            owner, repo, per_page: 100
          });

          const workflowGroups = {};
          for (const run of runs.data.workflow_runs) {
            if (!workflowGroups[run.workflow_id]) workflowGroups[run.workflow_id] = [];
            workflowGroups[run.workflow_id].push(run);
          }

          for (const [id, list] of Object.entries(workflowGroups)) {
            list.sort((a, b) => b.id - a.id);
            let foundSuccess = false;

            for (const run of list) {
              if (run.id === currentRunId) continue;
              if (run.status !== 'completed') continue;

              if (!foundSuccess && run.conclusion === 'success') {
                console.log(`âœ… Keep last success: ${run.name} (#${run.run_number})`);
                foundSuccess = true;
                continue;
              }
              try {
                await github.rest.actions.deleteWorkflowRun({ owner, repo, run_id: run.id });
                console.log(`ğŸ‘‹ Delete: ${run.name} (#${run.run_number})`);
              } catch (e) {}
            }
          }

    - name: Delete Old Releases (å¤ã„ãƒªãƒªãƒ¼ã‚¹ã®å‰Šé™¤)
      uses: actions/github-script@v7
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        github-token: ${{ env.GH_TOKEN }}
        script: |
          const keep_latest = 3;
          const { owner, repo } = context.repo;
          const { data: releases } = await github.rest.repos.listReleases({ owner, repo, per_page: 100 });
          
          for (const release of releases.slice(keep_latest)) {
            console.log(`ğŸ‘‹ Deleting Release: ${release.tag_name}`);
            await github.rest.repos.deleteRelease({ owner, repo, release_id: release.id });
            try {
              await github.rest.git.deleteRef({ owner, repo, ref: `tags/${release.tag_name}` });
            } catch (e) {}
          }
